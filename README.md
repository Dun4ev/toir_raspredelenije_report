# Скрипт `toir_raspredelenije.py`

## Назначение
Скрипт автоматически сортирует и архивирует PDF-отчёты на основании информации в их именах. Поддерживаются файлы вида `CT-DR-B-<part>-<object>-<TZ>-<period>-<date>-<revision>_All.pdf`. Дополнительно формируется JSONL-журнал с подробностями выполнения, который можно просматривать через настольный интерфейс.

## Точки входа
- `python toir_raspredelenije.py` — выполнить распределение для каталога по умолчанию (`INBOX_DIR`).
- `python toir_raspredelenije.py --` при установленной переменной окружения `TOIR_INBOX_DIR=...` — обработать альтернативный каталог.
- `python run_ui.py --base-dir logs/dispatch` — открыть Tkinter-интерфейс: вкладка «Распределение» для запуска пайплайна и вкладка «Журналы» для анализа; двойной клик по строке открывает папку назначения, отдельная кнопка удаляет все журналы кроме последнего.
- `python -m toir_manager report --base-dir logs/dispatch --json` — получить консольный отчёт по журналам.
- Цветовое кодирование UI: кнопка «Распределить» выделена синим (Primary), кнопки «Удалить» используют красный (Danger), нейтральные действия («Отмена», «Сбросить пути») — серый (Secondary).
- Пути, заданные в UI, сохраняются в `~/.toir_manager/ui_paths.json` (на Windows: `%USERPROFILE%\.toir_manager\ui_paths.json`) и подхватываются при следующем запуске.

## Константы и папки
- `INBOX_DIR` — ожидается структура `/<проект>/<файлы>`; в каждом проекте ищется единственный отчёт с суффиксом `_All`.
- `NOTES_DIR` — копия исходного PDF без изменений.
- `TRA_GST_DIR` — распределение по неделям: каталог `YYYY_TWW_GST`, где `WW` — ISO-неделя даты из имени файла. Если целевая неделя занята архивами, выбирается следующая неделя.
- `TRA_SUB_APP_DIR` — группировка для субподрядчиков: формируется по ключу `<tz_index>-<reserved>-<period>`; для периодов, отличных от `C`, добирается суффикс из `Template/TZ_glob.xlsx`.
- `DEST_ROOT_DIR` — основное дерево результатов `/<год>/<месяц>/<part>/{pdf,Native}/...`:
  - период `C` → папка «Корректирующее обслуживание»;
  - `LP` → папка по имени объекта (нормализованной: `BVS05` → `BVS5`); при необходимости используйте словарь `LP_FOLDER_OVERRIDES` для явного сопоставления.
  - `CS` → поиск существующей папки, начинающейся с индекса ТЗ (например, `II.12*`); при необходимости используйте словарь `CS_FOLDER_OVERRIDES` в скрипте для явного сопоставления (например, `"II.1.1" → "II.1"`).
- `TEMP_ARCHIVE_DIR` — временное место для создания zip-архива проекта; итоговый архив копируется в `Native`. После копирования временный zip удаляется.

## Логика распределения
1. Поиск `_All`-файлов в подпапках `INBOX_DIR`.
2. Разбор имени и подготовка метаданных (тип, объект, индекс ТЗ, дата, период).
3. Копирование PDF в `NOTES_DIR`, `TRA_GST_DIR`, `TRA_SUB_APP_DIR`, целевую папку в `DEST_ROOT_DIR/pdf`.
4. Архивация содержимого проекта и копирование архива в `DEST_ROOT_DIR/Native`.
5. Все операции журналируются в `logs/dispatch/<run_id>.jsonl` (статус, источники, назначения, сообщение об ошибке).

## Журналы и UI
JSONL-файлы можно просматривать:
- через вкладку «Журналы» в `run_ui.py`: список запусков, таблица действий, двойной клик открывает каталог назначения; кнопка «Удалить все кроме последнего» очищает историю;
- через команду `python -m toir_manager report ...` (выводит сводку и подробности).

## Требования и рекомендации
- Python ≥ 3.10, установленные зависимости: `openpyxl` (для чтения `TZ_glob.xlsx`). Tkinter входит в стандартную библиотеку.
- Перед запуском убедитесь, что пути в начале `toir_raspredelenije.py` указывают на тестовые каталоги и что структура `DEST_ROOT_DIR` содержит необходимые папки для `CS`-отчётов.
- Для пакетной обработки разных входных каталогов используйте `TOIR_INBOX_DIR` или вкладку «Распределение» в UI.
- Журналы занимают место на диске; очищайте папку `logs/dispatch` вручную или через кнопку в интерфейсе.
