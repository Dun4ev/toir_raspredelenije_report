# Сценарий `toir_raspredelenije.py`

> **Важно:** Каждый PDF-файл должен находиться внутри индивидуальной подпапки. При обнаружении PDF непосредственно в корне входного каталога обработка прерывается с предупреждением.

## Назначение
Утилита распределяет входящие проектные PDF‑отчёты по целевым каталогам и формирует журналы операций. Ожидается, что имена файлов соответствуют шаблону `CT-DR-B-<part>-<object>-<TZ>-<period>-<date>-<revision>_All.pdf`. Все действия фиксируются в JSONL‑логах, которые затем можно просматривать через UI или отчёты.

## Быстрый старт
- `python toir_raspredelenije.py` — запуск распределения для каталога по умолчанию (`INBOX_DIR`).
- `TOIR_INBOX_DIR=... python toir_raspredelenije.py` — однократный запуск с переопределённым путём до входных файлов.
- `python run_ui.py --base-dir logs/dispatch` — графический интерфейс на Tkinter для запуска пайплайна и просмотра журналов.
- `python -m toir_manager report --base-dir logs/dispatch --json` — сводный отчёт по выполненным операциям в формате JSON.
- UI использует стили: Primary (зелёные кнопки запуска), Danger (красные действия удаления), Secondary (серые вспомогательные).
- Сохранённые пути UI лежат в `~/.toir_manager/ui_paths.json` (Windows: `%USERPROFILE%\\.toir_manager\\ui_paths.json`).
- `toir_raspredelenije.exe` — собранный PyInstaller-дистрибутив; двойной клик запускает UI, а режим `toir_raspredelenije.exe --run-pipeline` выполняет конвейер без интерфейса.
- Имена файлов должны соответствовать шаблону и содержать только латиницу (A-Z, 0-9). При обнаружении кириллицы система выполняет автоматическую транслитерацию, а при невозможности — фиксирует ошибку и пропускает отчёт.

## Сборка и дистрибуция

- Активируйте виртуальное окружение и установите зависимости из `requirements.txt`.
- Выполните `pyinstaller ToirManager.spec --noconfirm`, чтобы получить готовый бинарь.
- Исполняемый файл располагается по пути `dist/toir_raspredelenije.exe`, рядом создаются нужные каталоги данных.
- Журналы распределения в собранной версии пишутся в `dist/logs/dispatch`.
- При необходимости изменить иконку, скрытые импорты или данные правьте `ToirManager.spec`.

## Основные каталоги
- `INBOX_DIR` — входной каталог вида `/ГОД/ПапкаПроекта`; утилита рекурсивно ищет каталоги с `_All.pdf` и считает проектом именно каталог, где лежит файл. В каждом таком каталоге должен находиться **только один** `_All.pdf`; если положить несколько файлов, будет обработан лишь первый.
- `NOTES_DIR` — место хранения копий отчётов для примечаний.
- `TRA_GST_DIR` — раскладка по неделям: каталоги `YYYY_TWW_GST`, где `WW` — номер ISO‑недели. При конфликте имён выбирается следующая неделя.
- `TRA_SUB_APP_DIR` — дополнительная структура, формируемая по ключу `<tz_index>-<reserved>-<period>`; для периодов `C` используется справочник `Template/TZ_glob.xlsx`.
- `DEST_ROOT_DIR` — итоговая структура `/Год/Месяц/<part>/{pdf,Native}/...`:
  - Период `C` → каталог «Корректирующее обслуживание».
  - `LP` → папки по объектам (с учётом нормализации, например `BVS05` → `BVS5`).
  - `CS` → поиск каталога по префиксу `CS_FOLDER_OVERRIDES` (например, `II.12*`).
- `TEMP_ARCHIVE_DIR` — рабочая директория для временных zip, после копирования архив удаляется.
- `TOIR_PART_FILTER` — ограничение по части: `LP`, `CS` или `CS/LP` (по умолчанию). Несоответствующие отчёты пропускаются без ошибок.
- `TOIR_DISPATCH_DIR` — путь к JSONL-журналам; по умолчанию `logs/dispatch` рядом с исполняемым кодом или бинарём. UI проставляет значение автоматически.
- `TOIR_TEMP_ARCHIVE_DIR` — временный каталог для сборки zip; по умолчанию `logs/temp` рядом с приложением. После успешной копии архив удаляется.
- Для проектов CS каталоги `pdf` и `Native` подбираются по справочнику и создаются автоматически при необходимости; событие отражается в логах.
- Период 'C'/'С' направляется в папку 'Корректирующее обслуживание' независимо от раскладки.

## Схема работы
1. Входной `_All` файл помещается в нужную подпапку `INBOX_DIR`.
2. Скрипт извлекает атрибуты имени файла (часть, объект, период, дата и т.д.).
3. PDF копируется в `NOTES_DIR`, `TRA_GST_DIR`, `TRA_SUB_APP_DIR`, профиль в `DEST_ROOT_DIR/pdf`.
4. Архив каталога проекта складывается в `DEST_ROOT_DIR/Native`.
5. Все шаги логируются в `logs/dispatch/<run_id>.jsonl` (в собранной версии каталог создаётся рядом с `toir_raspredelenije.exe`).

## UI
Журналы можно просматривать двумя способами:
- Вкладка «Распределение» (`run_ui.py`): запуск обработки, просмотр stdout/stderr, открытие целевых папок.
- Выпадающий список в блоке запуска позволяет выбрать фильтр части (`LP`/`CS`/`CS/LP`); выбор сохраняется и влияет на `TOIR_PART_FILTER`.
- Вкладка «Журналы»: список прогонов, просмотр таблицы файлов, массовое открытие директорий и очистка старых логов.

### План доработки INBOX
- Реализован рекурсивный обход `00_Inbox`: проект идентифицируется по каталогу, в котором найден `_All.pdf`.
- Переработать архивацию и логирование: гарантировать уникальные имена архивов и метаданных для каждого найденного отчёта в глубине.
- Актуализировать копирование в NOTES/TRA_GST/TRA_SUB/DEST_ROOT, чтобы корректно работать с новым контекстом и исключить коллизии путей.
- Подготовить тесты для вложенных структур и описать миграцию пользователей на новую схему раскладки.

### Вопросы на согласование
- Поддерживается произвольная глубина вложенности INBOX; ограничение по уровням введём отдельной задачей при появлении требований.
- Следует ли обрабатывать все `_All.pdf` в одной папке (несколько отчётов проекта) или лучше сигнализировать об ошибке?
- Какой формат архивов ожидается при нескольких файлах: один архив на каждый PDF или общий архив родительского каталога?
- Как адаптировать логику очистки INBOX в UI/CLI с появлением множественных подпапок?

