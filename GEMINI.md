# Проект GEMINI: Менеджер отчетов ТОиР

## 1. Обзор проекта

Этот проект представляет собой приложение для автоматизации обработки отчетов ТОиР и просмотра журналов операций. Он эволюционировал из одного скрипта в приложение со структурой `src-layout`, включающее CLI, десктопный UI и сервисный слой.

Ключевая функциональность:
- **Автоматическая сортировка**: Сканирует входной каталог, находит PDF-отчеты, разбирает их имена и распределяет по целевым папкам.
- **Архивация**: Создает zip-архивы исходных папок проекта.
- **Журналирование**: Все операции записываются в подробные `.jsonl` логи.
- **Интерфейсы**: Предоставляет как CLI для просмотра отчетов, так и UI для интерактивной работы.

## 2. Архитектура и структура

Проект использует `src-layout` для изоляции кода приложения.

```
repo/
├─ toir_raspredelenije.py  # Устаревший скрипт с основной логикой
├─ run_ui.py               # Точка входа для UI
├─ src/toir_manager/       # Основной пакет приложения
│  ├─ __main__.py          # Главная точка входа (CLI/UI)
│  ├─ core/                # Модели данных (logging_models.py)
│  ├─ services/            # Сервисы (log_reader.py, log_writer.py)
│  ├─ cli/                 # Код CLI (report.py)
│  └─ ui/                  # Код UI (desktop.py)
├─ Template/TZ_glob.xlsx   # Файл-справочник для логики
├─ logs/dispatch/          # Каталог с файлами журналов (*.jsonl)
└─ tests/                  # Тесты
```

### Компоненты
- **`toir_raspredelenije.py`**: Исторически главный скрипт, который до сих пор содержит основную бизнес-логику распределения. Он используется как библиотека в UI, но подлежит рефакторингу.
- **`src/toir_manager`**: Современная часть приложения.
    - **`core/logging_models.py`**: Определяет ключевые структуры данных:
        - `TransferLogEntry`: Запись в журнале (время, действие, статус, пути, метаданные).
        - `TransferAction`: Enum действий (e.g., `COPY_NOTES`, `CREATE_ARCHIVE`).
        - `TransferStatus`: Enum статусов (`SUCCESS`, `ERROR`).
    - **`services`**:
        - `log_writer.py`: `DispatchLogger` для потокобезопасной записи в `.jsonl` файлы.
        - `log_reader.py`: Функции для чтения, парсинга и агрегации данных из логов.
    - **`cli` и `ui`**: Реализация соответствующих интерфейсов.

## 3. Запуск и использование

### Установка
1.  Создайте и активируйте виртуальное окружение:
    ```bash
    python -m venv .venv
    .venv\Scripts\activate
    ```
2.  Установите зависимости:
    ```bash
    pip install --upgrade pip
    pip install openpyxl pytest
    ```

### Режимы запуска
- **CLI (просмотр журналов)**:
  ```bash
  # Показать список запусков
  python -m toir_manager report --list-runs

  # Показать детали и вывести в JSON
  python -m toir_manager report --show-details --json
  ```
- **UI (распределение и просмотр)**:
  ```bash
  python run_ui.py
  ```
  UI позволяет запустить обработку для выбранного каталога и анализировать журналы.
- **Прямой запуск (устаревший)**:
  ```bash
  # Использовать пути, заданные в скрипте
  python toir_raspredelenije.py

  # Переопределить входной каталог через переменную окружения
  $env:TOIR_INBOX_DIR="D:\path\to\another\inbox"
  python toir_raspredelenije.py
  ```

## 4. Ключевая бизнес-логика

Логика распределения сосредоточена в `toir_raspredelenije.py`.

### Схема имени файла
Скрипт ищет файлы, соответствующие регулярному выражению:
`^CT-(?P<type>CL|DR)-(?P<scope>...)-(?P<part>CS|LP)-(?P<object_name>...)-(?P<tz_index>...)-(?P<reserved>...)-(?P<period>...)-(?P<date>...)-(?P<revision>...)_All.*\.pdf$`

### Правила распределения
Для каждого найденного отчета выполняются следующие действия:
1.  **Копия в `03_Notes`**: Исходный PDF копируется "как есть".
2.  **Копия в `04_TRA_GST`**:
    - Папка назначения именуется по шаблону `[Год]_T[НомерНедели]_GST`.
    - Если в папке уже есть архив `CT-GST-TRA-PRM-*`, номер недели увеличивается до тех пор, пока не найдется "свободная" папка.
3.  **Копия в `05_TRA_SUB_app`**:
    - Формируется ключ: `{tz_index}-{reserved}-{period}`.
    - Если `period` равен `C` (или кириллической `С`), имя папки равно ключу.
    - Иначе, из `Template/TZ_glob.xlsx` ищется суффикс по `tz_index`, и имя папки становится `{ключ}_{суффикс}`.
4.  **Копия в основное хранилище (`DEST_ROOT_DIR`)**:
    - Путь: `[Год]/[Номер.Месяц]/[part]/{pdf,Native}/...
    - Конечное имя папки зависит от `part` и `period`:
        - **`period='C'`**: папка `Корректирующее обслуживание`.
        - **`part='LP'`**: папка по имени объекта (`object_name`). Применяется нормализация (`BVS05` -> `BVS5`).
        - **`part='CS'`**: папка ищется по префиксу `tz_index` (например, `II.1.1` -> `II.1*`). Для сложных случаев используются `CS_FOLDER_OVERRIDES`.
5.  **Архивация**: Исходная папка проекта архивируется в `.zip` и копируется в подпапку `Native`.

## 5. Тестирование

Проект содержит unit-тесты для проверки ключевых модулей:
- `test_logging_service.py`: Проверяет корректность записи и чтения логов, а также подсчет статистики.
- `test_cli_report.py`: Тестирует вывод CLI в формате JSON.
- `test_tra_sub_app.py`: Проверяет специфичную логику для `05_TRA_SUB_app`, включая обработку кириллических символов в имени.

Запуск тестов:
```bash
pytest -q
```